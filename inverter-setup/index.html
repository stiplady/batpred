<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Inverter Setup - Predbat Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Inverter Setup";
        var mkdocs_page_input_path = "inverter-setup.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Predbat Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../what-does-predbat-do/">What does Predbat do?</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Installing & configuring Predbat</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../installation-summary/">Install summary</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../install/">Install details</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Inverter Setup</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#givenergy-with-givtcp">GivEnergy with GivTCP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#solis-inverters">Solis Inverters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#solax-gen4-inverters">Solax Gen4 Inverters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sofar-inverters">Sofar Inverters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#huawei-inverters">Huawei Inverters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#solaredge-inverters">SolarEdge Inverters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#givenergy-with-ge_cloud">Givenergy with ge_cloud</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#givenergy-with-emc">Givenergy with EMC</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#fox">Fox</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sunsynk">Sunsynk</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#sunsynk-automations">SunSynk automations</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#predbat-chargedischarge-control">Predbat Charge/Discharge Control</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update-the-charge-limits-across-all-timezones">Update the charge limits across all timezone's</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sunsynk-value-templates">SunSynk Value templates</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#sunsynk-battery-max-charge-rate">Sunsynk Battery Max Charge Rate</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#sunsynk-battery-max-discharge-rate">Sunsynk Battery Max DisCharge Rate</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#sunsynk-charge-rate-calc">Sunsynk Charge Rate Calc</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#sunsynk-discharge-rate-calc">Sunsynk Discharge Rate Calc</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#i-want-to-add-an-unsupported-inverter-to-predbat">I want to add an unsupported inverter to Predbat</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#inverter-control-option">Inverter control option</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#has_rest_api">has_rest_api</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_mqtt_api">has_mqtt_api</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#service-api">Service API</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#charge_start_service">charge_start_service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#discharge_start_service">discharge_start_service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#charge_stop_service">charge_stop_service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#discharge_stop_service">discharge_stop_service</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#output_charge_control">output_charge_control</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#charge_control_immediate">charge_control_immediate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#current_dp">current_dp</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_charge_enable_time">has_charge_enable_time</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_discharge_enable_time">has_discharge_enable_time</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_target_soc">has_target_soc</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_reserve_soc">has_reserve_soc</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_timed_pause">has_timed_pause</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#charge_time_format">charge_time_format</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#charge_time_entity_is_option">charge_time_entity_is_option</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#clock_time_format">clock_time_format</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#soc_units">soc_units</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#time_button_press">time_button_press</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#support_charge_freeze">support_charge_freeze</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#support_discharge_freeze">support_discharge_freeze</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_ge_inverter_mode">has_ge_inverter_mode</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#num_load_entities">num_load_entities</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#write_and_poll_sleep">write_and_poll_sleep</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#has_idle_time">has_idle_time</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#can_span_midnight">can_span_midnight</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#charge_discharge_with_rate">charge_discharge_with_rate</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../energy-rates/">Energy rates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../apps-yaml/">apps.yaml settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../car-charging/">Car charging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../configuration-guide/">Configuration guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../customisation/">Customisation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../video-guides/">Video Guides</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../faq/">FAQ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../devices/">Support 3rd party devices/integrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../manual-api/">Predbat automation API</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Viewing Predbat data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../output-data/">Output data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../predbat-plan-card/">Predbat Plan card</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../creating-charts/">Creating the charts</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Predbat development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../todo-list/">To-do list</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../developing/">Developing on Predbat</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Predheat</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../predheat/">predheat</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Predbat Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Installing & configuring Predbat</li>
      <li class="breadcrumb-item active">Inverter Setup</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="inverter-setup">Inverter Setup</h1>
<p>PredBat was originally written for GivEnergy inverters using the GivTCP integration but this is now being extended to other inverter models:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Integration</th>
<th style="text-align: left;">Template</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">GivEnergy with GivTCP</td>
<td style="text-align: left;"><a href="https://github.com/britkat1980/ha-addons">GivTCP</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/givenergy_givtcp.yaml">givenergy_givtcp.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Solis Hybrid inverters</td>
<td style="text-align: left;"><a href="https://github.com/wills106/homeassistant-solax-modbus">Solax Modbus integration</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/ginlong_solis.yaml">ginlong_solis.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Solax Gen4 inverters</td>
<td style="text-align: left;"><a href="https://github.com/wills106/homeassistant-solax-modbus">Solax Modbus integration</a> in Modbus Power Control Mode</td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/solax_sx4.yaml">solax_sx4.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Sofar inverters</td>
<td style="text-align: left;"><a href="https://github.com/cmcgerty/Sofar2mqtt">Sofar MQTT integration</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/sofar.yaml">sofar.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Huawei inverters</td>
<td style="text-align: left;"><a href="https://github.com/wlcrs/huawei_solar">Huawei Solar</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/huawei.yaml">huawei.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">SolarEdge inverters</td>
<td style="text-align: left;"><a href="https://github.com/WillCodeForCats/solaredge-modbus-multi">Solaredge Modbus Multi</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/solaredge.yaml">solaredge.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Givenergy with GE Cloud</td>
<td style="text-align: left;"><a href="https://github.com/springfall2008/ge_cloud">ge_cloud</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/givenergy_cloud.yaml">givenergy_cloud.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Givenergy with GE Cloud EMC</td>
<td style="text-align: left;"><a href="https://github.com/springfall2008/ge_cloud">ge_cloud</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/givenergy_ems.yaml">givenergy_ems.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">SunSynk</td>
<td style="text-align: left;"><a href="https://github.com/kellerza/sunsynk">Sunsynk</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/sunsynk.yaml">sunsynk.yaml</a></td>
</tr>
<tr>
<td style="text-align: left;">Fox</td>
<td style="text-align: left;"><a href="https://github.com/nathanmarlor/foxess_modbus">Foxess</a></td>
<td style="text-align: left;"><a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/fox.yaml">fox.yaml</a></td>
</tr>
</tbody>
</table>
<p>Note that support for all these inverters is in various stages of development. Please expect things to fail and report them as Issues on Github.</p>
<p>NB: By default the apps.yaml template for GivTCP is installed with Predbat.
If you are using a different inverter then you will need to copy the appropriate apps.yaml template from the above list and use it to <strong>replace the GivTCP apps.yaml</strong> - if
you copy but don't replace the standard template then Predbat will not function correctly.</p>
<h2 id="givenergy-with-givtcp">GivEnergy with GivTCP</h2>
<p>Its recommended that you firstly watch the <a href="https://www.youtube.com/watch?v=ygD9KyciX54">Installing GivTCP and Mosquitto Add-on's video from Speak to the Geek</a>.
Although the video covers GivTCP v2 and v3 has been recently released, the install and setup process is very similar.</p>
<p>The below instructions assume you are installing GivTCP v3, with changes highlighted against GivTCP v2 as covered in the video.</p>
<ol>
<li>Install Mosquitto Broker add-on:</li>
</ol>
<ul>
<li>Go to Settings / Add-ons / Add-on Store (bottom right)</li>
<li>Scroll down the add-on store list, to find 'Mosquitto broker', click on the add-on, then click 'INSTALL'</li>
<li>Once the Mosquitto broker has been installed, ensure that the 'Start on boot' and 'Watchdog' options are turned on, and click 'START' to start the add-on</li>
<li>Next, configure Mosquitto broker by going to Settings / Devices and Services / Integrations.
Mosquitto broker should appear as a Discovered integration so click the blue 'CONFIGURE' button, then SUBMIT to complete configuring Mosquitto broker</li>
<li>With GivTCP v3 you no longer need to create a dedicated Home Assistant user for MQTT so this part of the video can be skipped over</li>
</ul>
<ol start="2">
<li>Install the GivTCP add-on:</li>
</ol>
<ul>
<li>Go to Settings / Add-ons / Add-on Store</li>
<li>Click the three dots in the top right corner, then Repositories</li>
<li>You'll need to add the GivTCP repository as an additional custom repository so paste/type
'<a href="https://github.com/britkat1980/ha-addons'">https://github.com/britkat1980/ha-addons</a>' into the text box and click 'Add' the 'Close'<BR>
NB: this URL is for GivTCP v3, not v2 as covered in the video.</li>
<li>Click the back button and then re-navigate to Settings / Add-ons / Add-on Store so Home Assistant picks up the GivTCP add-on from the custom repository</li>
<li>Scroll down the add-on store list, to find 'GivTCP-V3', you should see the three addon's; the production version, the latest beta and the latest dev versions.
Click on the 'GivTCP' add-on, then click 'INSTALL'</li>
<li>Once GivTCP has been installed, ensure that the 'Start on boot' and 'Watchdog' options are turned on</li>
</ul>
<ol start="3">
<li>Configure GivTCP:</li>
</ol>
<ul>
<li>The configuration process for GivTCP in v3 has changed from that shown in the video,
the Configuration tab is now no longer used and all configuration is now done via the add-on's Web interface</li>
<li>On the GivTCP add-on, click 'START' to start the add-on</li>
<li>Once the add-on has started, click 'Open Web UI' or go to <a href="http://homeassistant.local:8099/">http://homeassistant.local:8099/</a>, then click 'Go to Config Page' to configure GivTCP</li>
<li>GivTCP will auto-discover your inverters and batteries so you shouldn't need to manually enter these, but check the IP address(s) it finds are correct</li>
<li>If you have multiple inverters you may wish to change the default device prefixes that GivTCP assigns ('givtcp', 'givtcp2', 'givtcp3', etc)
to make it easier to identify your devices within Home Assistant.<BR>
For example if you have a gateway and two AIO's you could use the prefixes 'GW', 'AIO-1' and 'AIO-2'.
The prefixes should be set before you start using GivTCP in anger
as changing the prefixes later on will result in both the old and new sensor names appearing in Home Assistant with the 'old' sensors being "unavailable".<BR>
Note that if you do change the givtcp prefixes then you will also have to edit the apps.yaml configuration file to match,
and change the sensor names that predbat is looking for (by default prefixed 'givtcp_xxx') to your new sensor naming structure</li>
<li>Click Next and Next to get to the Selfrun page, and turn on Self run. The Self Run Loop Timer is how often GivTCP will retrieve data from your inverters - it's
recommended that set this to a value between 20 and 60, but not less than 15 seconds as otherwise the inverter will then spend all its time talking to GivTCP
and won't communicate with the GivEnergy portal and app</li>
<li>GivTCP now auto-populates the MQTT page so as long as you're using Mosquitto broker within Home Assistant;
you won't need to create a dedicated MQTT user or enter the details on the MQTT page</li>
<li>You don't need to configure the Influx page. Tariff and Palm pages can also be skipped as these functions are done by Predbat</li>
<li>(Optional) On the Web page, you can turn the Dashboard on to see a simple power flow diagram for your inverters (similar to the GivEnergy mobile app)</li>
<li>On the 'Misc' page check that 'Print Raw' is set to on for added monitoring</li>
<li>Finally click 'Save and Restart' and GivTCP should start communicating with your inverters
and will automatically create a set of 'givtcp_xxx' entities in Home Assistant for your inverter data, inverter controls and battery data</li>
<li>Check the GivTCP Log tab that there aren't any errors; it should end with 'Publishing Home Assistant Discovery messages'</li>
</ul>
<ol start="4">
<li>Specific Predbat configuration requirements for certain GivEnergy equipment</li>
</ol>
<p>The rest of the <a href="../install/">Predbat installation instructions</a> should now be followed,
but its worth highlighting that there are a few specific settings that should be set for certain GivEnergy equipment.
These settings are documented in the appropriate place in the documentation, but for ease of identification, are repeated here:</p>
<ul>
<li>If you are using GivTCP v3 and have an AIO or 3 phase inverter then you will need to manually set <a href="../apps-yaml/#geserial">geserial in apps.yaml</a> to your inverter serial number</li>
<li>If you have a single AIO then control is directly to the AIO. Ensure <a href="../apps-yaml/#geserial">geserial in apps.yaml</a> is correctly picking the AIO and comment out geserial2 lines</li>
<li>If you have multiple AIO's then all control of the AIO's is done through the Gateway so <a href="../apps-yaml/#geserial">geserial in apps.yaml</a> should be set to the Gateway serial number</li>
<li>If you have a 2.6kWh, 5.2kWh or AIO battery then you will need to set <a href="../apps-yaml/#battery-size-scaling">battery_scaling in apps.yaml</a>
as the battery size is incorrectly reported to GivTCP</li>
<li>If you have a Gen 2, Gen 3 or AIO then you may need to set <a href="../apps-yaml/#inverter-reserve-maximum">inverter_reserve_max in apps.yaml</a> to 98.
If you have a Gen 1 or a firmware version that allows reserve being set to 100 then you can change the default from 98 to 100</li>
<li>If your inverter has been wired as an EPS (Emergency Power Supply) or AIO 'whole home backup', consider setting
<a href="../customisation/#inverter-control-options">input_number.predbat_set_reserve_min</a> to reserve some battery power for use in emergencies.</li>
</ul>
<p><strong>NB: GivTCP and Predbat do not currently yet work together for 3 phase inverters</strong>.
This is being worked on by the author of GivTCP, e.g. see <a href="https://github.com/britkat1980/giv_tcp/issues/218">GivTCP issue: unable to charge or discharge 3 phase inverters with predbat</a></p>
<h2 id="solis-inverters">Solis Inverters</h2>
<p>To run PredBat with Solis hybrid inverters, follow the following steps:</p>
<ol>
<li>Install PredBat as per the <a href="../installation-summary/">Installation Summary</a></li>
<li>Ensure that you have the Solax Modbus integration running. There are a number of entities which this integration disables by default that you
   will need to enable via the Home Assistant GUI:</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>sensor.solisx_rtc</code></td>
<td style="text-align: left;">Real Time Clock</td>
</tr>
<tr>
<td style="text-align: left;"><code>sensor.solisx_battery_power</code></td>
<td style="text-align: left;">Battery Power</td>
</tr>
</tbody>
</table>
<ol start="4">
<li>Instead of <code>apps.yaml</code> use <code>ginlong_solis.yaml</code> from this Repo as your starting template.
   The majority of settings should be correct but please check.
   You will need to un-comment the <code>template</code> line to enable it. Save it to the <code>config/appdaemon/apps/predbat/config</code> folder.
   Set <strong>solax_modbus_new</strong> in apps.yaml to True if you have integration version 2024.03.2 or greater</li>
<li>Ensure that the inverter is set Control Mode 35 - on the Solax integration this is <code>Timed Charge/Discharge</code>.
   If you want to use the <code>Reserve</code> functionality within PredBat you will need to select <code>Backup/Reserve</code> (code 51) instead but be aware that
   this is not fully tested. In due course these mode settings will be incorporated into the code.</li>
</ol>
<h2 id="solax-gen4-inverters">Solax Gen4 Inverters</h2>
<p>Use the template configuration from: <a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/solax_sx4.yaml">solax.sx4.yaml</a></p>
<ul>
<li>Set <strong>solax_modbus_new</strong> in apps.yaml to True if you have integration version 2024.03.2 or greater</li>
</ul>
<p>Please see this ticket in Github for ongoing discussion: <a href="https://github.com/springfall2008/batpred/issues/259">https://github.com/springfall2008/batpred/issues/259</a></p>
<h2 id="sofar-inverters">Sofar Inverters</h2>
<p>For this integration the key elements are:</p>
<ul>
<li>Hardware - <a href="https://www.instructables.com/Sofar2mqtt-Remote-Control-for-Sofar-Solar-Inverter/">sofar2mqtt EPS board</a> - Relatively easy to solder and flash, or can be bought pre-made.</li>
<li>Software - <a href="https://github.com/cmcgerty/Sofar2mqtt">Sofar MQTT integration</a> - MQTT integration</li>
<li>Home Assistant configuration - <a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/sofar_inverter.yml">sofar_inverter.yaml</a> package (in templates directory)
with the MQTT sensors. This is the default with a couple of additional inputs to support battery capacity. This should be installed in Home Assistant.</li>
<li>
<p>Predbat configuration - <a href="https://raw.githubusercontent.com/springfall2008/batpred/main/templates/sofar.yaml">sofar.yaml</a> template for Predbat (in templates directory).
This file should be copied to apps.yaml</p>
</li>
<li>
<p>Please note that the inverter needs to be put into "Passive Mode" for the sofar2mqtt to control the inverter.</p>
</li>
<li>This integration has various limitations, it can charge and discharge the battery but does not have finer control over reserve and target SOC%</li>
<li>Note: You will need to change the min reserve in Home Assistant to match your minimum battery level (<strong>input_number.predbat_set_reserve_min</strong>).</li>
</ul>
<p>Please see this ticket in Github for ongoing discussions: <a href="https://github.com/springfall2008/batpred/issues/395">https://github.com/springfall2008/batpred/issues/395</a></p>
<h2 id="huawei-inverters">Huawei Inverters</h2>
<p>Discussion ticket is here: <a href="https://github.com/springfall2008/batpred/issues/684">https://github.com/springfall2008/batpred/issues/684</a></p>
<ul>
<li>Please copy the template apps.yaml from <a href="https://github.com/springfall2008/batpred/blob/main/templates/huawei.yaml">https://github.com/springfall2008/batpred/blob/main/templates/huawei.yaml</a> and modify for your system</li>
<li>Ensure you set <strong>input_number.predbat_set_reserve_min</strong> to the minimum value for your system which maybe 12%</li>
</ul>
<h2 id="solaredge-inverters">SolarEdge Inverters</h2>
<p>Discussion ticket is here: <a href="https://github.com/springfall2008/batpred/issues/181">https://github.com/springfall2008/batpred/issues/181</a></p>
<ul>
<li>Please copy the template apps.yaml from <a href="https://github.com/springfall2008/batpred/blob/main/templates/solaredge.yaml">https://github.com/springfall2008/batpred/blob/main/templates/solaredge.yaml</a> and modify for your system</li>
<li>Ensure that <strong>number.solaredge_i1_storage_command_timeout</strong> is set to reasonably high value e.g. 3600 seconds to avoid the commands issued being cancelled</li>
<li>
<p>Power Control Options, as well as Enable Battery Control, must be enabled in the Solaredge Modbus Multi integration configuration,
and switch.solaredge_i1_advanced_power_control must be on.</p>
</li>
<li>
<p>For <strong>pv_today</strong>, <strong>pv_power</strong> and <strong>load_power</strong> sensors to work you need to create this as a template within your Home Assistant configuration.yml
Please see: <a href="https://gist.github.com/Ashpork/f80fb0d3cb22356a12ed24734065061c">https://gist.github.com/Ashpork/f80fb0d3cb22356a12ed24734065061c</a>. These sensors are not critical so you can just comment it out in apps.yaml
if you can't get it to work</p>
</li>
</ul>
<pre><code class="language-yaml">template:
  - sensor:
      - name: &quot;Solar Panel Production W&quot;
        unique_id: solar_panel_production_w
        unit_of_measurement: &quot;W&quot;
        icon: mdi:solar-power
        state: &gt;
          {% set i1_dc_power = states('sensor.solaredge_i1_dc_power') | float(0) %}
          {% set b1_dc_power = states('sensor.solaredge_b1_dc_power') | float(0) %}
          {% if (i1_dc_power + b1_dc_power &lt;= 0) %}
            0
          {% else %}
            {{ (i1_dc_power + b1_dc_power) }}
          {% endif %}
        availability: &gt;
          {{ states('sensor.solaredge_i1_dc_power') | is_number and states('sensor.solaredge_b1_dc_power') | is_number }}

      - name: &quot;Solar House Consumption W&quot;
        unique_id: solar_house_consumption_w
        unit_of_measurement: &quot;W&quot;
        icon: mdi:home
        state: &gt;
          {% set i1_ac_power = states('sensor.solaredge_i1_ac_power') | float(0) %}
          {% set m1_ac_power = states('sensor.solaredge_m1_ac_power') | float(0) %}
          {% if (i1_ac_power - m1_ac_power &lt;= 0) %}
            0
          {% else %}
            {{ (i1_ac_power - m1_ac_power) }}
          {% endif %}
        availability: &gt;
          {{ states('sensor.solaredge_i1_ac_power') | is_number and states('sensor.solaredge_m1_ac_power') | is_number }}

sensor:
  - platform: integration
    source: sensor.solar_panel_production_w
    method: left
    unit_prefix: k
    name: solar_panel_production_kwh
</code></pre>
<h2 id="givenergy-with-ge_cloud">Givenergy with ge_cloud</h2>
<p>This is experimental system, please discuss on the ticket: <a href="https://github.com/springfall2008/batpred/issues/905">https://github.com/springfall2008/batpred/issues/905</a></p>
<ul>
<li>First set up ge_cloud integration using your API key <a href="https://github.com/springfall2008/ge_cloud">https://github.com/springfall2008/ge_cloud</a></li>
<li>Now copy the template givenergy_cloud.yaml from templates into your apps.yaml and edit<ul>
<li>Set geserial to your inverter serial</li>
</ul>
</li>
<li>Make sure discharge down to registers are set to 4% and slots 2, 3 and 4 for charge and discharge are disabled (if you have them)</li>
</ul>
<h2 id="givenergy-with-emc">Givenergy with EMC</h2>
<ul>
<li>First set up ge_cloud integration using your API key <a href="https://github.com/springfall2008/ge_cloud">https://github.com/springfall2008/ge_cloud</a></li>
<li>Now copy the template givenergy_emc.yaml from templates into your apps.yaml and edit<ul>
<li>Set geserial to your first inverter serial and geserial2 to the second (look in HA for entity names)</li>
<li>Set geseriale to the EMS inverter serial number (look in HA for entity names)</li>
</ul>
</li>
<li>Turn off slots 2, 3 and 4 for charge, export and discharge as Predbat will only use 1 slot (set the start and end times to 00:00)</li>
</ul>
<h2 id="fox">Fox</h2>
<p><strong>Experimental</strong></p>
<ul>
<li>I've managed to get Batpred working on my Fox ESS inverter, connected via an Elfin EW11 modbus and using Nathan's Fox ESS Modbus tool.
See: <a href="https://github.com/springfall2008/batpred/issues/1401">https://github.com/springfall2008/batpred/issues/1401</a></li>
</ul>
<p>Template is in the templates area, give it a try</p>
<h2 id="sunsynk">Sunsynk</h2>
<ul>
<li>Copy the Sunsynk apps.yaml template and edit for your system.</li>
<li>Create the automations below</li>
<li>Create the value templates below</li>
</ul>
<p>See: <a href="https://github.com/springfall2008/batpred/issues/1331">https://github.com/springfall2008/batpred/issues/1331</a></p>
<h3 id="sunsynk-automations">SunSynk automations</h3>
<p>Copy into your HA automations</p>
<h4 id="predbat-chargedischarge-control">Predbat Charge/Discharge Control</h4>
<pre><code class="language-yaml">alias: Predbat Charge / Discharge Control
description: &quot;&quot;
trigger:
  - platform: state
    entity_id:
      - binary_sensor.predbat_charging
    to: &quot;on&quot;
    id: predbat_charge_on
  - platform: state
    entity_id:
      - binary_sensor.predbat_charging
    to: &quot;off&quot;
    id: predbat_charge_off
  - platform: state
    entity_id:
      - binary_sensor.predbat_discharging
    to: &quot;on&quot;
    id: predbat_discharge_on
  - platform: state
    entity_id:
      - binary_sensor.predbat_discharging
    to: &quot;off&quot;
    id: predbat_discharge_off
condition: []
action:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - predbat_charge_on
        sequence:
          - service: switch.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: switch.sunsynk_grid_charge_timezone1
      - conditions:
          - condition: trigger
            id:
              - predbat_charge_off
        sequence:
          - service: switch.turn_off
            target:
              entity_id:
                - switch.sunsynk_grid_charge_timezone1
            data: {}
      - conditions:
          - condition: trigger
            id:
              - predbat_discharge_on
        sequence:
          - service: switch.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: switch.sunsynk_solar_sell
      - conditions:
          - condition: trigger
            id:
              - predbat_discharge_off
        sequence:
          - service: switch.turn_off
            target:
              entity_id:
                - switch.sunsynk_solar_sell
            data: {}
mode: single
</code></pre>
<h4 id="update-the-charge-limits-across-all-timezones">Update the charge limits across all timezone's</h4>
<pre><code class="language-yaml">alias: PredBat - Copy Charge Limit
description: Copy Battery SOC to all time slots
trigger:
  - platform: state
    entity_id:
      - number.sunsynk_set_soc_timezone1
    to: null
condition: []
action:
  - service: number.set_value
    data_template:
      entity_id:
        - number.sunsynk_set_soc_timezone2
        - number.sunsynk_set_soc_timezone3
        - number.sunsynk_set_soc_timezone4
        - number.sunsynk_set_soc_timezone5
        - number.sunsynk_set_soc_timezone6
      value: &quot;{{ states('number.sunsynk_set_soc_timezone1')|int(20) }}&quot;
mode: single
</code></pre>
<h3 id="sunsynk-value-templates">SunSynk Value templates</h3>
<p>Copy into your template/sensor area of configuration.yaml</p>
<pre><code class="language-yaml">template:
  sensor:
    xxxxx
</code></pre>
<h4 id="sunsynk-battery-max-charge-rate">Sunsynk Battery Max Charge Rate</h4>
<pre><code class="language-yaml">- name: &quot;sunsynk_max_battery_charge_rate&quot;
  unit_of_measurement: &quot;w&quot;
  state_class: measurement
  state: &gt;
    {{ [8000,[states('input_number.sunsynk_battery_max_charge_current_limit')|int,states('sensor.sunsynk_battery_charge_limit_current')|int]|min
        * states('sensor.sunsynk_battery_voltage')|float]|min }}
</code></pre>
<h4 id="sunsynk-battery-max-discharge-rate">Sunsynk Battery Max DisCharge Rate</h4>
<pre><code class="language-yaml">- name: &quot;sunsynk_max_battery_discharge_rate&quot;
  unit_of_measurement: &quot;w&quot;
  state_class: measurement
  state: &gt;
    {{ [8000,[states('input_number.sunsynk_battery_max_discharge_current_limit')|int,states('sensor.sunsynk_battery_discharge_limit_current')|int]|min
        * states('sensor.sunsynk_battery_voltage')|float]|min }}
</code></pre>
<h4 id="sunsynk-charge-rate-calc">Sunsynk Charge Rate Calc</h4>
<pre><code class="language-yaml">- name: &quot;sunsynk_charge_rate_calc&quot;
  unit_of_measurement: &quot;w&quot;
  state_class: measurement
  state: &gt;
     {{ [8000,[states('input_number.test_sunsynk_battery_max_charge_current')|int,states('sensor.sunsynk_battery_charge_limit_current')|int]|min
         * states('sensor.sunsynk_battery_voltage')|float]|min }}
</code></pre>
<h4 id="sunsynk-discharge-rate-calc">Sunsynk Discharge Rate Calc</h4>
<pre><code class="language-yaml">- name: &quot;sunsynk_discharge_rate_calc&quot;
  unit_of_measurement: &quot;w&quot;
  state_class: measurement
  state: &gt;
     {{ [8000,[states('input_number.test_sunsynk_battery_max_discharge_current')|int,states('sensor.sunsynk_battery_discharge_limit_current')|int]|min
         * states('sensor.sunsynk_battery_voltage')|float]|min }}
</code></pre>
<h2 id="i-want-to-add-an-unsupported-inverter-to-predbat">I want to add an unsupported inverter to Predbat</h2>
<ul>
<li>First copy one of the template configurations that is close to your system and try to configure it to match the sensors you have</li>
<li>Create a github ticket for support and add in what you know to the ticket</li>
<li>Then find out how to control your inverter inside Home Assistant, ideally share any automation you have to control the inverter</li>
<li>You can create a new inverter type in apps.yaml and change the options as to which controls it has</li>
<li>The easy way to integrate is to use a HA service to start charges and discharges, edit the template below</li>
</ul>
<pre><code class="language-yaml"> inverter_type: MINE
 inverter:
    name : &quot;My Shiny new Inverter&quot;
    has_rest_api: False
    has_mqtt_api: False
    output_charge_control: &quot;power&quot;
    has_charge_enable_time: False
    has_discharge_enable_time: False
    has_target_soc: False
    has_reserve_soc: False
    charge_time_format: &quot;S&quot;
    charge_time_entity_is_option: False
    soc_units: &quot;%&quot;
    num_load_entities: 1
    has_ge_inverter_mode&quot;: False
    time_button_press: False
    clock_time_format: &quot;%Y-%m-%d %H:%M:%S&quot;
    write_and_poll_sleep: 2
    has_time_window: False
    support_charge_freeze: False
    support_discharge_freeze&quot;: False

  # Services to control charging/discharging
  charge_start_service:
    service: select.select_option
    entity_id: &quot;select.solaredge_i1_storage_command_mode&quot;
    option: &quot;Charge from Solar Power and Grid&quot;
  charge_stop_service:
    service: select.select_option
    entity_id: &quot;select.solaredge_i1_storage_command_mode&quot;
    option: &quot;Charge from Solar Power&quot;
  discharge_start_service:
    service: select.select_option
    entity_id: &quot;select.solaredge_i1_storage_command_mode&quot;
    option: &quot;Maximize Self Consumption&quot;

</code></pre>
<h2 id="inverter-control-option">Inverter control option</h2>
<p>The follow options are supported per inverter:</p>
<h3 id="has_rest_api">has_rest_api</h3>
<p>When True the REST API will be used to fetch data/control the inverter. This is currently only for GivEnergy inverters with GivTCP and <strong>givtcp_rest</strong> must be set in apps.yaml</p>
<h3 id="has_mqtt_api">has_mqtt_api</h3>
<p>When True the MQTT API to Home Assistant will be used to issue control messages for the inverter</p>
<p>The mqtt/publish service is used with the topic as defined by <strong>mqtt_topic</strong> in apps.yaml</p>
<p>Messages will be sent these controls:</p>
<p>Values that are updated:</p>
<ul>
<li><strong>topic</strong>/set/reserve  - payload=reserve</li>
<li><strong>topic</strong>/set/charge_rate - payload=new_rate</li>
<li><strong>topic</strong>/set/discharge_rate - payload=new_rate</li>
<li><strong>topic</strong>/set/target_soc - payload=target_soc</li>
</ul>
<p>These three change between battery charge/discharge and auto (idle) mode:</p>
<ul>
<li><strong>topic</strong>/set/charge - payload=charge_rate</li>
<li><strong>topic</strong>/set/discharge - payload=discharge_rate</li>
<li><strong>topic</strong>/set/auto - payload=true</li>
</ul>
<h3 id="service-api">Service API</h3>
<p>When True a Home Assistant service will be used to issue control messages for the inverter</p>
<p>For each service you wish to use it must be defined in apps.yaml.</p>
<p>There are two ways to define a service, the basic mode:</p>
<pre><code class="language-yaml">charge_start_service: my_service_name_charge
</code></pre>
<p>Will call my_service_name_charge for the charge start service.</p>
<p>Or the custom method:</p>
<pre><code class="language-yaml">charge_start_service:
   - service: my_charge_start_service
     device_id: {device_id}
     power: {power}
     soc: {target_soc}
</code></pre>
<p>Here you can define all the values passed to the service and use the default values from the template or define your own.</p>
<p>You can also call more than one service e.g:</p>
<pre><code class="language-yaml">charge_start_service:
   - service: my_charge_start_service
     device_id: {device_id}
     power: {power}
     soc: {target_soc}
   - service: switch.turn_off
     entity_id: switch.tsunami_charger
</code></pre>
<h4 id="charge_start_service">charge_start_service</h4>
<p>Called to start a charge</p>
<p>The default options passed in are:</p>
<ul>
<li>device_id - as defined in apps.yaml by <strong>device_id</strong></li>
<li>target_soc - The SOC to charge to</li>
<li>power - The charge power to use</li>
</ul>
<h4 id="discharge_start_service">discharge_start_service</h4>
<p>Called to start a discharge</p>
<p>The default options passed in are:</p>
<ul>
<li>device_id - as defined in apps.yaml by <strong>device_id</strong></li>
<li>target_soc - The SOC to discharge to</li>
<li>power - The discharge power to use</li>
</ul>
<h4 id="charge_stop_service">charge_stop_service</h4>
<p>Called to stop a charge or stop a discharge</p>
<p>device_id - as defined in apps.yaml by <strong>device_id</strong></p>
<h4 id="discharge_stop_service">discharge_stop_service</h4>
<p>Called to stop a discharge</p>
<ul>
<li>device_id - as defined in apps.yaml by <strong>device_id</strong></li>
</ul>
<h3 id="output_charge_control">output_charge_control</h3>
<p>Set to power, current or none</p>
<p>When power the inverter has a <strong>charge_rate</strong> and <strong>discharge_rate</strong> setting in watts defined in apps.yaml</p>
<p>When current the inverter has  <strong>timed_charge_current</strong> and <strong>timed_discharge_current</strong> setting in amps defined in apps.yaml</p>
<h3 id="charge_control_immediate">charge_control_immediate</h3>
<p>When True the inverter <strong>timed_charge_current</strong> or <strong>timed_discharge_current</strong> is used to control charging or discharging as/when it starts and stops rather than using a timed method.</p>
<h3 id="current_dp">current_dp</h3>
<p>Sets the number of decimal places when setting the current in Amps, should be 0 or 1</p>
<h3 id="has_charge_enable_time">has_charge_enable_time</h3>
<p>When True the inverter has a setting defined in apps.yaml called <strong>scheduled_charge_enable</strong> when can be used to enable/disable timed charging.</p>
<h3 id="has_discharge_enable_time">has_discharge_enable_time</h3>
<p>When True the inverter has a setting defined in apps.yaml called <strong>scheduled_discharge_enable</strong> when can be used to enable/disable timed discharging.</p>
<h3 id="has_target_soc">has_target_soc</h3>
<p>When True the inverter has a target soc setting in apps.yaml called <strong>charge_limit</strong>, when False charging must be turned on and off by Predbat rather
than the inverter doing it based on the target %</p>
<h3 id="has_reserve_soc">has_reserve_soc</h3>
<p>When True the inverter has a reserve soc setting in apps.yaml called <strong>reserve</strong></p>
<h3 id="has_timed_pause">has_timed_pause</h3>
<p>When True the inverter has a setting in apps.yaml called <strong>pause_mode</strong> and settings <strong>pause_start_time</strong> and <strong>pause_end_time</strong> which can be used to pause the inverter from
charging and discharging the battery - this is for GivEnergy systems only right now.</p>
<h3 id="charge_time_format">charge_time_format</h3>
<p>When set to "HH:MM:SS" the inverter has:</p>
<p><strong>charge_start_time</strong> <strong>charge_end_time</strong>
<strong>discharge_start_time</strong> <strong>discharge_end_time</strong></p>
<p>Which are option selectors in the format HH:MM:SS (e.g. 12:23:00) where seconds are always 00.</p>
<p>When set to "H M" the inverter has:</p>
<p><strong>charge_start_hour</strong> <strong>charge_end_hour</strong> <strong>charge_start_minute</strong> <strong>charge_end_minute</strong>
<strong>discharge_start_hour</strong> <strong>discharge_end_hour</strong> <strong>discharge_start_minute</strong> <strong>discharge_end_minute</strong></p>
<p>Settings in apps.yaml which can be used to set the start and end times of charges and discharges</p>
<h3 id="charge_time_entity_is_option">charge_time_entity_is_option</h3>
<p>When True <strong>charge_start_time</strong> <strong>charge_end_time</strong> <strong>discharge_start_time</strong> and <strong>discharge_end_time</strong> are all Options, when false they are number values.</p>
<h3 id="clock_time_format">clock_time_format</h3>
<p>Defines the time format of the inverter clock setting <strong>inverter_time</strong> in apps.yaml</p>
<h3 id="soc_units">soc_units</h3>
<p>Defines the units of the SOC setting (currently not used)</p>
<h3 id="time_button_press">time_button_press</h3>
<p>When true the inverter has a button press which is needed to update the inverter registers from the Home Assistant values.</p>
<p>The apps.yaml setting <strong>charge_discharge_update_button</strong> is the entity name of the button that must be pressed and polled until it updates after each inverter register change.</p>
<h3 id="support_charge_freeze">support_charge_freeze</h3>
<p>When True the inverter supports charge freeze modes</p>
<h3 id="support_discharge_freeze">support_discharge_freeze</h3>
<p>When True the inverter supports discharge freeze modes</p>
<h3 id="has_ge_inverter_mode">has_ge_inverter_mode</h3>
<p>When True the inverter as the GivEnergy inverter modes (ECO, Timed Export etc).</p>
<h3 id="num_load_entities">num_load_entities</h3>
<p>Sets the number of <strong>load_power_n</strong> settings in apps.yaml are present in addition to <strong>load_power</strong> (the default)</p>
<h3 id="write_and_poll_sleep">write_and_poll_sleep</h3>
<p>Sets the number of seconds between polls of inverter settings</p>
<h3 id="has_idle_time">has_idle_time</h3>
<p>When True the inverter has an idle time register which must be set to the start and end times for ECO mode (GivEnergy EMC)</p>
<h3 id="can_span_midnight">can_span_midnight</h3>
<p>When True start and end times for charge and discharge can span midnight e.g. 23:00:00 - 01:00:00 is a 2 hour slot.</p>
<h3 id="charge_discharge_with_rate">charge_discharge_with_rate</h3>
<p>When True when charging discharge rate must be 0 and visa-versa. When false the rate does not have to change.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../install/" class="btn btn-neutral float-left" title="Install details"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../energy-rates/" class="btn btn-neutral float-right" title="Energy rates">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../install/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../energy-rates/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
